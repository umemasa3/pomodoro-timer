name: Lighthouse CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  lighthouse-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd pomodoro-timer
          pnpm install --frozen-lockfile

      - name: Build application
        run: |
          cd pomodoro-timer
          pnpm build
        env:
          # Lighthouse CIç”¨ã®ç’°å¢ƒå¤‰æ•°
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: |
          cd pomodoro-timer
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-reports
          path: pomodoro-timer/lighthouse-reports/

      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lighthouseçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const reportsDir = 'pomodoro-timer/lighthouse-reports';
            if (!fs.existsSync(reportsDir)) {
              console.log('Lighthouse reports directory not found');
              return;
            }
            
            const files = fs.readdirSync(reportsDir);
            const jsonFiles = files.filter(file => file.endsWith('.json'));
            
            if (jsonFiles.length === 0) {
              console.log('No Lighthouse JSON reports found');
              return;
            }
            
            // æœ€æ–°ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—
            const latestReport = jsonFiles.sort().pop();
            const reportPath = path.join(reportsDir, latestReport);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            
            // ã‚¹ã‚³ã‚¢ã‚’å–å¾—
            const categories = report.categories;
            const scores = {
              performance: Math.round(categories.performance.score * 100),
              accessibility: Math.round(categories.accessibility.score * 100),
              'best-practices': Math.round(categories['best-practices'].score * 100),
              seo: Math.round(categories.seo.score * 100),
              pwa: Math.round(categories.pwa.score * 100),
            };
            
            // Core Web Vitalsã‚’å–å¾—
            const audits = report.audits;
            const lcp = audits['largest-contentful-paint'].displayValue;
            const fid = audits['max-potential-fid'].displayValue;
            const cls = audits['cumulative-layout-shift'].displayValue;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
            const comment = `
            ## ğŸš¦ Lighthouse CI Results
            
            ### Scores
            | Category | Score |
            |----------|-------|
            | ğŸš€ Performance | ${scores.performance}/100 |
            | â™¿ Accessibility | ${scores.accessibility}/100 |
            | ğŸ›¡ï¸ Best Practices | ${scores['best-practices']}/100 |
            | ğŸ” SEO | ${scores.seo}/100 |
            | ğŸ“± PWA | ${scores.pwa}/100 |
            
            ### Core Web Vitals
            | Metric | Value |
            |--------|-------|
            | LCP (Largest Contentful Paint) | ${lcp} |
            | FID (First Input Delay) | ${fid} |
            | CLS (Cumulative Layout Shift) | ${cls} |
            
            ### Recommendations
            ${scores.performance < 90 ? 'âš ï¸ Performance score is below 90. Consider optimizing images, reducing bundle size, or improving server response times.' : 'âœ… Great performance score!'}
            ${scores.accessibility < 90 ? 'âš ï¸ Accessibility score is below 90. Review color contrast, alt text, and keyboard navigation.' : 'âœ… Excellent accessibility!'}
            ${scores['best-practices'] < 90 ? 'âš ï¸ Best practices score is below 90. Check for security issues and modern web standards compliance.' : 'âœ… Following best practices!'}
            
            ---
            *Report generated on ${new Date().toISOString()}*
            `;
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check Lighthouse thresholds
        run: |
          cd pomodoro-timer
          # Lighthouse CIã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          if [ -f "lighthouse-reports/manifest.json" ]; then
            echo "âœ… Lighthouse CI completed successfully"
            
            # çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ€ä½ã‚¹ã‚³ã‚¢ã‚’ãƒã‚§ãƒƒã‚¯
            node -e "
              const fs = require('fs');
              const manifest = JSON.parse(fs.readFileSync('lighthouse-reports/manifest.json', 'utf8'));
              const reports = manifest.map(item => JSON.parse(fs.readFileSync(item.jsonPath, 'utf8')));
              
              let failed = false;
              reports.forEach((report, index) => {
                const scores = {
                  performance: report.categories.performance.score * 100,
                  accessibility: report.categories.accessibility.score * 100,
                  'best-practices': report.categories['best-practices'].score * 100,
                  seo: report.categories.seo.score * 100
                };
                
                console.log(\`Report \${index + 1} scores:\`, scores);
                
                // é–¾å€¤ãƒã‚§ãƒƒã‚¯
                if (scores.performance < 80) {
                  console.error('âŒ Performance score below threshold (80)');
                  failed = true;
                }
                if (scores.accessibility < 90) {
                  console.error('âŒ Accessibility score below threshold (90)');
                  failed = true;
                }
                if (scores['best-practices'] < 90) {
                  console.error('âŒ Best practices score below threshold (90)');
                  failed = true;
                }
              });
              
              if (failed) {
                process.exit(1);
              } else {
                console.log('âœ… All Lighthouse thresholds passed');
              }
            "
          else
            echo "âŒ Lighthouse reports not found"
            exit 1
          fi

  # æœ¬ç•ªç’°å¢ƒã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ï¼ˆæœ¬ç•ªURLã«å¯¾ã—ã¦å®Ÿè¡Œï¼‰
  production-lighthouse:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: lighthouse-ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse on production
        run: |
          # æœ¬ç•ªURLã«å¯¾ã—ã¦Lighthouseå®Ÿè¡Œ
          lhci collect --url=https://pomodoro-timer.vercel.app --numberOfRuns=3
          lhci assert --preset=lighthouse:recommended
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload production Lighthouse reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: production-lighthouse-reports
          path: .lighthouseci/

      - name: Notify on performance regression
        if: failure()
        run: |
          echo "ğŸš¨ Performance regression detected on production!"
          echo "Please review the Lighthouse reports and consider rolling back if necessary."