# リアルタイム同期機能実装ドキュメント

## 概要

タスク12.1「Supabaseリアルタイム同期の実装」として、以下の機能を実装しました：

1. **リアルタイム同期サービス** - タスクとセッションのリアルタイム同期
2. **オフライン対応** - ネットワーク切断時のローカルストレージ活用
3. **自動同期** - ネットワーク復旧時の自動データ同期
4. **同期状態表示** - ユーザーへの同期状態の可視化

## 実装したファイル

### 新規作成ファイル

1. **`src/services/realtime-sync-service.ts`**
   - リアルタイム同期の中核サービス
   - オフライン対応とローカルキャッシュ管理
   - 未同期変更の管理と自動同期

2. **`src/components/sync-status-indicator.tsx`**
   - 同期状態を表示するUIコンポーネント
   - ネットワーク状態と未同期変更数の表示
   - 手動同期ボタン

3. **`database/enable-realtime.sql`**
   - Supabaseリアルタイム機能有効化用SQLスクリプト

4. **`src/services/__tests__/realtime-sync-service.test.ts`**
   - リアルタイム同期サービスのユニットテスト

### 修正したファイル

1. **`src/stores/timer-store.ts`**
   - リアルタイム同期機能の統合
   - ネットワーク状態管理
   - 同期状態の表示

2. **`src/services/database-service.ts`**
   - オフライン対応の追加
   - ローカルキャッシュとの連携

3. **`src/App.tsx`**
   - 同期状態インジケーターの追加
   - リアルタイム同期の初期化

## 機能詳細

### 1. リアルタイム同期

#### 対象テーブル

- `tasks` - タスクデータ
- `sessions` - セッションデータ
- `tags` - タグデータ（将来対応）
- `task_tags` - タスク-タグ関連（将来対応）

#### 同期イベント

- `INSERT` - 新規データ作成時
- `UPDATE` - データ更新時
- `DELETE` - データ削除時

### 2. オフライン対応

#### ローカルストレージキー

- `pomodoro-tasks-cache` - タスクキャッシュ
- `pomodoro-sessions-cache` - セッションキャッシュ（最新100件）
- `pomodoro-pending-changes` - 未同期変更リスト

#### オフライン時の動作

1. **データ作成**: 一時的なIDでローカル作成、未同期キューに追加
2. **データ更新**: ローカルキャッシュを更新、未同期キューに追加
3. **データ取得**: ローカルキャッシュから取得

### 3. 自動同期

#### 同期トリガー

- ネットワーク復旧時（`online` イベント）
- アプリケーション起動時
- 手動同期ボタンクリック時

#### 同期処理

1. 未同期変更を順次処理
2. 失敗した変更は再試行キューに保持
3. 成功した変更は未同期キューから削除

### 4. 同期状態表示

#### 表示内容

- **オンライン状態**: 緑（オンライン）/ 赤（オフライン）
- **未同期変更数**: 数値で表示
- **同期状態**: idle / syncing / error
- **手動同期ボタン**: 必要時のみ表示

#### 表示条件

- オフライン時は常に表示
- オンラインでも未同期変更がある場合は表示
- 同期完了時は自動的に非表示

## 使用方法

### 1. Supabaseリアルタイム機能の有効化

```sql
-- Supabaseダッシュボードで実行
ALTER PUBLICATION supabase_realtime ADD TABLE tasks;
ALTER PUBLICATION supabase_realtime ADD TABLE sessions;
ALTER PUBLICATION supabase_realtime ADD TABLE tags;
ALTER PUBLICATION supabase_realtime ADD TABLE task_tags;
```

### 2. アプリケーションでの利用

リアルタイム同期は自動的に初期化されます：

```typescript
// タイマーストアで自動初期化
const { initializeRealtimeSync } = useTimerStore();

useEffect(() => {
  if (isAuthenticated && user) {
    initializeRealtimeSync();
  }
}, [isAuthenticated, user]);
```

### 3. 手動同期

```typescript
const { forcSync } = useTimerStore();

// 手動同期の実行
await forcSync();
```

## テスト

### ユニットテスト

```bash
# リアルタイム同期サービスのテスト
pnpm test src/services/__tests__/realtime-sync-service.test.ts
```

### 統合テスト

```bash
# 全体のビルドテスト
pnpm build

# 全体のテスト実行
pnpm test:all
```

## 動作確認

### 1. オンライン時の動作確認

1. アプリケーションを起動
2. タスクを作成・更新・削除
3. 別のブラウザタブで同じユーザーでログイン
4. リアルタイムでデータが同期されることを確認

### 2. オフライン時の動作確認

1. ブラウザの開発者ツールでネットワークを無効化
2. 同期状態インジケーターが「オフライン」表示になることを確認
3. タスクを作成・更新
4. ネットワークを有効化
5. 自動的に同期されることを確認

### 3. 手動同期の動作確認

1. オフライン状態で変更を行う
2. ネットワークを有効化
3. 同期状態インジケーターの「同期」ボタンをクリック
4. 未同期変更が同期されることを確認

## パフォーマンス考慮事項

### 1. ローカルキャッシュ最適化

- セッションキャッシュは最新100件のみ保持
- 不要なデータは定期的にクリーンアップ
- メモリ使用量の監視

### 2. 同期頻度の制御

- リアルタイム同期は必要最小限に制限
- バッチ処理による効率化
- エラー時の指数バックオフ

### 3. ネットワーク使用量

- 差分同期による通信量削減
- 圧縮可能なデータ形式の使用
- 不要な同期の回避

## セキュリティ考慮事項

### 1. Row Level Security (RLS)

- Supabaseの行レベルセキュリティを活用
- ユーザーは自分のデータのみアクセス可能
- 認証状態の厳密なチェック

### 2. データ検証

- クライアント側での入力検証
- サーバー側での再検証
- 不正なデータの拒否

### 3. 認証トークン管理

- JWTトークンの適切な管理
- 有効期限の監視
- 自動リフレッシュ機能

## トラブルシューティング

### 1. 同期が動作しない場合

1. Supabaseリアルタイム機能が有効化されているか確認
2. ネットワーク接続状態を確認
3. ブラウザコンソールでエラーログを確認
4. 認証状態を確認

### 2. パフォーマンスが低下する場合

1. ローカルストレージの使用量を確認
2. 未同期変更の蓄積状況を確認
3. ネットワーク通信量を監視
4. メモリ使用量を確認

### 3. データの不整合が発生する場合

1. 競合解決ロジックの確認
2. タイムスタンプの同期確認
3. データベース制約の確認
4. 手動でのデータ修正

## 今後の拡張予定

### 1. 競合解決機能

- 同時編集時の競合検出
- 自動マージ機能
- ユーザー選択による解決

### 2. 同期履歴管理

- 同期操作の履歴記録
- エラー履歴の保持
- 統計情報の収集

### 3. 高度な同期制御

- 選択的同期機能
- 同期優先度の設定
- バックグラウンド同期

## まとめ

リアルタイム同期機能により、以下の要件が満たされました：

- **要件12.1**: タスクとセッションのリアルタイム同期
- **要件12.2**: 設定変更の永続化
- **要件12.3**: アプリケーション再起動時の状態復元
- **要件12.4**: オフライン時のローカルストレージ活用
- **要件12.5**: ネットワーク復旧時の自動同期
- **要件12.6**: データ同期エラー時の適切な通知

この実装により、ユーザーはネットワーク状態に関係なく快適にアプリケーションを使用でき、複数デバイス間でのデータ同期も実現されています。
